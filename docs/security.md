# ğŸ›¡ï¸ Security & Safety

This document outlines the security architecture and safety mechanisms built into the Autonomous Stock Trading Agent to protect both your data and your capital.

## 1. Financial Safety Rails

The agent is designed with multiple layers of protection to prevent catastrophic financial loss.

### ğŸ’° Capital Limits
Hard limits are enforced at the application level, independent of broker settings. The agent **cannot** trade more than the configured maximums.

- **`US_MAX_CAPITAL`**: Maximum capital allocated to US markets (Default: $500).
- **`INDIA_MAX_CAPITAL`**: Maximum capital allocated to Indian markets (Default: â‚¹12,000).
- **`MAX_RISK_PER_TRADE`**: Default 2% of total capital per trade to ensure diversification.

### ğŸ˜ˆ Devil's Advocate (AI Risk Review)
Every trade signal generated by the primary AI Analyst is submitted to a secondary, skeptical "Risk Manager" AI.
- **Role**: Strictly critiques the trade setup.
- **Criteria**: Checks for technical flaws (e.g., buying at resistance), liquidity risks (low volume), and emotional/hallucinated reasoning.
- **Outcome**: If the Risk Manager rejects the trade, it is **blocked** immediately.

### ğŸ•’ Market Gating
The agent strictly adheres to market hours using the `exchange_calendars` library.
- **Live Mode**: Trades are only executed when the specific market (NYSE/NASDAQ or NSE/BSE) is openly trading.
- **Holidays**: Automatically detects and skips trading on public holidays.
- **Gap Protection**: Prevents orders from being placed when markets are closed, avoiding "gap down" executions at the next open.

---

## 2. Code & Data Security

### ğŸ”‘ Credential Management
- **No Hardcoded Secrets**: API keys, passwords, and tokens are strictly managed via environment variables (`.env`).
- **Pydantic Validation**: Configuration is loaded into strict Pydantic models (`agent_config.py`), which validate data types and prevent injection of malformed config.
- **Git Safety**: Critical files (`.env`, `*.db`, `__logs__/`, `__databases__/`) are strictly ignored by `.gitignore` to prevent accidental commits of sensitive data.

### ğŸ’‰ SQL Injection Prevention
- **ORM usage**: The core application uses **SQLModel/SQLAlchemy**, which inherently sanitizes all inputs before database execution.
- **Parameterized Queries**: The Dashboard (`dashboard.py`) uses parameterized SQL queries (e.g., `WHERE timestamp >= ?`) for all filtering and data retrieval. **No** user input is ever concatenated directly into SQL strings.

### ğŸ“ Data Isolation
- **Databases**: Stored in `__databases__/`, isolated from the source code.
- **Logs**: stored in `__logs__/`.
- **Scripts/Tests**: Moved to dedicated `scripts/` and `tests/` directories to reduce the attack surface of the root directory.

---

## 3. Operational Security

### ğŸ“ Logging & Audit Trails
Every action is logged to `__logs__/agent.jsonl`:
- **Traceability**: Every trade, signal, and API call includes a timestamp and context.
- **Transparency**: You can audit exactly *why* the AI made a decision (including the full prompt and response).

### ğŸ”„ Crash Recovery
The main event loop is wrapped in robust error handling.
- **Failure Containment**: Unhandled exceptions in one strategy cycle are caught, logged, and do not crash the entire agent (unless critical/fatal).
- **Retry Logic**: Transient network errors (e.g., broker API timeout) trigger a retry with backoff, ensuring resilience.

---

## 4. Best Practices for Users

### âš ï¸ Recommended Setup
1.  **Run in Docker (Optional)**: For maximum isolation, run the agent within a Docker container to limit its access to your host file system.
2.  **Least Privilege API Keys**: check your broker settings to ensure API keys meant for this agent have trade permissions but **cannot withdraw funds** if possible.
3.  **Monitor the Dashboard**: Keep the dashboard running to supervise the agent's activity in real-time.

### ğŸš¨ Emergency Stop
To immediately stop the agent:
- Press `Ctrl+C` in the terminal running `main.py`.
- In an extreme scenario (e.g., broker API loop), execute `kill -9 <process_id>` or revoke the API keys from your broker's portal.
